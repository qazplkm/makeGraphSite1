<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bootstrap demo</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi"
      crossorigin="anonymous"
    />
    <link href="main.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  </head>
  <body>

    <div class="top-wrap hide">
      <h4>그래프 자세히보기</h4>
    </div>

    
    <div class="data-container up100">
      <div class="data-container-position">
        <div class="databox">
          <div>
            <h1>그래프를 만들어보자</h1>
          </div>

          <div>
            <p>그래프 형태선택</p>
            <select id="GraphFormType">
              <option>선그래프</option>
              <option>바그래프</option>              
            </select>
            <button type="button" class="btn btn-primary" id="GraphFormTypeBtn">그래프모양선택</button>
            <!-- <button id="GraphFormTypeBtn">그래프모양선택</button> -->
          </div>
          <div>
            <p><span>0&lt;</span> 그래프크기 <span>&gt;=100</span> </p>
            <input id="graph-size" type="number" value="100" /><span>%</span>
            <p>그래프이름</p>
            <input id="graph-name" type="text" />
            <button id="change-graph-btn">버튼</button> 
          </div>         

        </div>

        <div class="data-container-foot">
          <h4>그래프 만들기</h4>
        </div>

      </div>
    </div>  
    

    <div class="container">
      <button id="screenShot">그래프스샷</button>

      <div class="chart-container">
        <canvas id="myChart"></canvas>
      </div>
    </div>
    
    <script type="module">    
    import {선그래프, 바그래프} from './graphTypes.js'  

      let graph = document.querySelector("#myChart");      
      // 그래프 인풋창 여닫기
      let topWrap = document.querySelector(".top-wrap");
      let dataContainer = document.querySelector(".data-container");
      let dataContainerFoot = document.querySelector(".data-container-foot");
      
      dataContainerFoot.addEventListener('click',function(){
        dataContainer.classList.remove('up100');
        topWrap.classList.remove('hide');
        dataContainerFoot.className += ' hide'
      })
      
      topWrap.addEventListener('click',function(){
        topWrap.className += ' hide';
        dataContainer.className += ' up100';
        dataContainerFoot.classList.remove('hide');
      })

      // 그래프 형태 선택 및 뒤로가기
      let 그래프형태 = 선그래프;
      let 그래프모양선택버튼 = document.getElementById('GraphFormTypeBtn');
      let 선택된그래프모양 = document.getElementById('GraphFormType');
        // 만약 그래프형태를 선택하고 다음버튼을 누르면 그래프형태를 그에 해당하는 그래프변수로 바꿈,
        // 그리고 그래프에 해당되는 변수를 만듬
      그래프모양선택버튼.addEventListener('click',function(){
        그래프형태 = 선택된그래프모양;
        chartContainer.innerHTML = `<canvas id="myChart"></canvas>`;

      })
        
      
      

      // 그래프데이타 인풋
      let graphName = document.getElementById("graph-name");
      let graphSize = document.getElementById("graph-size");
      let changeGraphBtn = document.getElementById("change-graph-btn");

      // 숫자입력칸 경고
        // 그래프크기
      let chartContainer = document.querySelector('.chart-container');
      graphSize.addEventListener('input',function(){
        if(graphSize.value == ''){
          alert('숫자만입력하세요')
          graphSize.value = 100;
        }
      })
      

      // 그래프에 데이타 적용
        // 그래프사이즈
        function 그래프사이즈조정(){
          if(parseFloat(graphSize.value)/100 > 0 && parseFloat(graphSize.value)/100 <= 1){
            chartContainer.style.transform = `scale(${parseFloat(graphSize.value)/100})`;
          }else{
            alert('0 초과 100이하의 숫자 사이에서 입력하세요.')
          }
        }
      changeGraphBtn.addEventListener("click", function () {
        console.log(graphName.value);
        console.log(myChart.data.datasets[0].label);
        console.log(graphSize.value)
        그래프사이즈조정()              
        
        myChart.data.datasets[0].label = graphName.value;
        myChart.update();
      });
      

      // 스샷버튼
      let screenShot = document.getElementById("screenShot");
      screenShot.addEventListener("click", function () {
        makeDivToImageFile(graph);
      });      

      function saveAs(url, fileName) {
        const link = document.createElement("a");
        link.href = url;
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function makeDivToImageFile(graph) {
        html2canvas(graph, {
          allowTaint: true,
          useCORS: true,
          /* 아래 3 속성이 canvas의 크기를 정해준다. */
          width: graph.offsetWidth,
          height: graph.offsetHeight,
          scale: parseFloat(graphSize.value)/100,
        })
          .then(function (canvas) {
            const imageURL = canvas.toDataURL("image/jpeg");
            saveAs(imageURL, "new file.jpg");
          })
          .catch(function (err) {
            console.log(err);
          });
      }


      // 그래프 차트
      var ctx = document.getElementById("myChart").getContext("2d");
      var myChart = new Chart(ctx, 그래프형태);
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
